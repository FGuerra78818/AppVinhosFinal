@* _LoginPartial.cshtml *@
@using Microsoft.AspNetCore.Mvc
@{
    var isAuth = Context.User.Identity?.IsAuthenticated == true;
    var userName = Context.User.Identity?.Name;
}

@if (isAuth)
{
    <div class="d-flex align-items-center">
        <!-- Dropdown de Notificações -->
        <div class="dropdown me-3">
            <a class="nav-link position-relative p-0" href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-bell fs-5"></i>
                <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" style="font-size:.6rem;">0</span>
            </a>
            <ul id="notifItems" class="dropdown-menu dropdown-menu-end" aria-labelledby="notifDropdown" style="width:300px; max-height:400px; overflow-y:auto;">
                <li class="dropdown-header">Notificações</li>
                <li><hr class="dropdown-divider" /></li>
                <li class="placeholder"><a class="dropdown-item text-muted" href="#">Sem novas notificações</a></li>
            </ul>
        </div>

        <!-- Dropdown de Perfil -->
        <div class="dropdown">
            <a class="nav-link p-0 d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle fs-5"></i>
                <span class="ms-1 d-none d-lg-inline">@userName</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li><h6 class="dropdown-header">Minha Conta</h6></li>
                <li><a class="dropdown-item" asp-controller="Account" asp-action="Profile">Perfil</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                    <form asp-controller="Account" asp-action="Logout" method="post" class="m-0">
                        <button type="submit" class="dropdown-item">
                            <i class="bi bi-box-arrow-right me-1"></i>Sair
                        </button>
                    </form>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                    <a class="dropdown-item" asp-controller="Account" asp-action="Registration">
                        <i class="bi bi-person-plus me-1"></i>Registar
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Script SignalR para notificações -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        (function() {
            // Guarda a conexão global para evitar múltiplas instâncias
            if (!window.notificationConnection) {
                window.notificationConnection = new signalR.HubConnectionBuilder()
                    .withUrl('/notificationHub', { withCredentials: true })
                    .build();

                const conn = window.notificationConnection;

                const redirectUrl = '@(User.IsInRole("Admin") ? Url.Action("Index", "AllPedidos") : Url.Action("Index", "Pedidos"))';

                conn.on('ReceiveNotification', data => {
                    const msg = data.Mensagem || data.mensagem || data.message || 'Nova notificação';

                    // Atualiza badge
                    const badge = document.getElementById('notifBadge');
                    const current = parseInt(badge.textContent || '0', 10) || 0;
                    badge.textContent = current + 1;
                    badge.classList.remove('d-none');

                    // Insere na lista, evitando duplicados
                    const container = document.getElementById('notifItems');
                    const placeholder = container.querySelector('li.placeholder');
                    if (placeholder) placeholder.remove();

                    const exists = [...container.querySelectorAll('a.dropdown-item')]
                        .some(el => el.textContent.trim() === msg.trim());
                    if (!exists) {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.className = 'dropdown-item';
                        a.href = redirectUrl;
                        a.textContent = msg;
                        li.appendChild(a);
                        // Insere após o cabeçalho e divider
                        const insertIndex = 2; // após <li>header e <li><hr>
                        if (container.children.length > insertIndex) {
                            container.insertBefore(li, container.children[insertIndex]);
                        } else {
                            container.appendChild(li);
                        }
                    }
                });

                conn.start().catch(err => console.error('SignalR error:', err));
            }
        })();
    </script>
}
else
{
    <div class="d-flex align-items-center">
        <a class="nav-link d-flex align-items-center me-3" asp-controller="Account" asp-action="Login">
            <i class="bi bi-box-arrow-in-right fs-5 me-1"></i>Login
        </a>
    </div>
}
